trigger:
  tags:
    include:
    - 'v*'
  branches:
    include:
    - '*'
variables:
- group: TestPyPi
stages:
- stage: Test
  jobs:
  - job: Test
    strategy:
      matrix:
#        'Python 3.8/Linux':
#          image: 'ubuntu-20.04'
#          pythonVersion: '3.8'
#        'Python 3.9/Linux':
#          image: 'ubuntu-20.04'
#          pythonVersion: '3.9'
        'Python 3.10/Linux':
          image: 'ubuntu-20.04'
          pythonVersion: '3.10'
        'Python 3.10/Mac OS 11':
          image: 'macOS-11'
          pythonVersion: '3.10'
#        'Windows Server 2019':
#          image: 'windows-2019'
#          pythonVersion: '3.8'

    pool:
      vmImage: $(image)

    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    - script: |
        pip install -U poetry
        pip install -U tox
      displayName: 'Install Poetry'

    - bash: |
        PYENV=$(sed -e 's/\.//' <<< "py$(pythonVersion)")
        poetry run tox -e $PYENV
      displayName: 'Running tests via tox'

- stage: Deploy
  condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/v') )
  jobs:
  - job: Deploy
    variables:
      image: 'ubuntu-20.04'
      pythonVersion: '3.10'

    pool:
      vmImage: $(image)

    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '$(pythonVersion)'

    - script: |
        pip install -U poetry
        pip install -U tox
      displayName: 'Install Poetry'

    - script: |
        echo ">>>>>>" $(PYPI_HOST)
        echo ">>>>>>" $(PYPI_TEST)
      displayName: 'Test output Macro'

#    - script: |
#        poetry config http-basic.testpypi $(PYPI_USER) $(PYPI_TOKEN)
#        poetry config repositories.testpypi $(PYPI_HOST)
#      displayName: 'Config Poetry for Deployment'
#
#    - script: |
#        poetry install -v
#        poetry build
#      displayName: 'Build'
